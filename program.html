<!DOCTYPE html>
<html>

<head>
    <title>
        Nanonaut Action
    </title>
</head>

<body>
    <script>

        //CONSTANTS
        var CANVAS_WIDTH = 800;
        var CANVAS_HIEGHT = 600;

        var PLAYER_WIDTH = 181;
        var PLAYER_HEIGHT = 229;
        var PLAYER_X_SPEED = 5;
        var PLAYER_Y_ACCELERATION = 1;
        var PLAYER_JUMP_SPEED = 20;
        var PLAYER_NR_ANIMATION_FRAMES = 7;
        var PLAYER_ANIMATION_SPEED = 3;

        var ROBOT_WIDTH = 141;
        var ROBOT_HEIGHT = 139;
        var ROBOT_NR_ANIMATION_FRAMES = 9;
        var ROBOT_ANIMATION_SPEED = 5;
        var ROBOT_X_SPEED = 4;
        var MIN_DISTANCE_BETWEEN_ROBOTS = 400;
        var MAX_DISTANCE_BETWEEN_ROBOTS = 1200;
        var MAX_ACTIVE_ROBOTS = 3;

        var SPACE_KEYCODE = 32;
        var BACKGROUND_WIDTH = 1000;
        var gameFrameCounter = 0;
        var GROUND_Y = 540;

        //SETUP
        var canvas = document.createElement('canvas');
        var c = canvas.getContext('2d');
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HIEGHT;
        document.body.appendChild(canvas);

        var playerImage = new Image();
        playerImage.src = 'visuals/AnimatedNanonaut.png';
        var playerSpriteSheet = {
            nrFramesPerRow: 5,
            spriteWidth: PLAYER_WIDTH,
            spriteHeight: PLAYER_HEIGHT,
            image: playerImage
        };
        var playerCollisionRectangle = {
            xOffset: 60,
            yOffset: 20,
            width: 50,
            height: 200
        };

        var robotImage = new Image();
        robotImage.src = 'visuals/AnimatedRobot.png'
        var robotSpriteSheet = {
            nrFramesPerRow: 3,
            spriteWidth: ROBOT_WIDTH,
            spriteHeight: ROBOT_HEIGHT,
            image: robotImage
        };
        var robotData = [];
        var robotCollisionRectangle = {
            xOffset: 50,
            yOffset: 20,
            width: 50,
            height: 100
        }

        var bush1Image = new Image();
        bush1Image.src = 'visuals/bush1.png';
        var bush2Image = new Image();
        bush2Image.src = 'visuals/bush2.png';

        var backgroundImage = new Image();
        backgroundImage.src = 'visuals/background.png';

        var playerX = CANVAS_WIDTH / 2;
        var playerY = GROUND_Y - PLAYER_HEIGHT;
        var playerYSpeed = 0;
        var spaceKeyIsPressed = false;
        var playerIsInTheAir = false;
        var cameraX = 0;
        var cameraY = 0;
        var playerFrameNr = 0;
        var bushData = generateBushes();

        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);

        window.addEventListener('load', start);

        function start() {
            window.requestAnimationFrame(mainLoop);
        }

        function generateBushes() {
            var generateBushData = [];
            var bushX = 0;
            while (bushX < (2 * CANVAS_WIDTH)) {
                var bushImage;
                if (Math.random() >= 0.5) {
                    bushImage = bush1Image;
                } else {
                    bushImage = bush2Image;
                }
                generateBushData.push({
                    x: bushX,
                    y: 80 + Math.random() * 20,
                    image: bushImage
                });
                bushX += 150 + Math.random() * 200;
            }
            return generateBushData;
        }

        //MAIN LOOP
        function mainLoop() {
            update();
            draw();
            window.requestAnimationFrame(mainLoop);

            // setTimeout(mainLoop, 1000);
        }

        //PLAYER INPUT
        function onKeyDown(event) {
            if (event.keyCode === SPACE_KEYCODE) {
                spaceKeyIsPressed = true;
            }
        }
        function onKeyUp(event) {
            if (event.keyCode === SPACE_KEYCODE) {
                spaceKeyIsPressed = false;
            }
        }

        //UPDAING
        function update() {
            gameFrameCounter = gameFrameCounter + 1;

            //SPEEED
            playerX = playerX + PLAYER_X_SPEED;

            //jump for mr Nano.
            if (spaceKeyIsPressed && !playerIsInTheAir) {
                playerYSpeed = - PLAYER_JUMP_SPEED;
                playerIsInTheAir = true;
            }

            //gravity for mr. Nano
            playerY = playerY + playerYSpeed;

            playerYSpeed = playerYSpeed + PLAYER_Y_ACCELERATION;

            if (playerY > (GROUND_Y - PLAYER_HEIGHT)) {
                playerY = GROUND_Y - PLAYER_HEIGHT;
                playerYSpeed = 0;
                playerIsInTheAir = false;
            }

            //Update animation
            if ((gameFrameCounter % PLAYER_ANIMATION_SPEED) === 0) {
                playerFrameNr = playerFrameNr + 1;
                if (playerFrameNr >= PLAYER_NR_ANIMATION_FRAMES) {
                    playerFrameNr = 0;
                }
            }

            //Update camera
            cameraX = playerX - 150;

            //teleporting da bushes
            for (var i = 0; i < bushData.length; i++) {
                if ((bushData[i].x - cameraX) < - CANVAS_WIDTH) {
                    bushData[i].x += (2 * CANVAS_WIDTH) + 150;
                }

                //Robot command
                updateRobots();
            }
        }

        //robot robatics
        function updateRobots() {
            //moving and animating robots
            for (var i = 0; i < robotData.length; i++) {
                if (doesPlayerOverlapRobot(
                    playerX + playerCollisionRectangle.xOffset,
                    playerY + playerCollisionRectangle.yOffset,
                    playerCollisionRectangle.width,
                    playerCollisionRectangle.height,
                    robotData[i].x + robotCollisionRectangle.xOffset,
                    robotData[i].y + robotCollisionRectangle.yOffset,
                    robotCollisionRectangle.width,
                    robotCollisionRectangle.heigth
                )) {
                    console.log('OUCHI!');
                }
                robotData[i].x -= ROBOT_X_SPEED;
                if ((gameFrameCounter % ROBOT_ANIMATION_SPEED) === 0) {
                    robotData[i].frameNr = robotData[i].frameNr + 1;
                    if (robotData[i].frameNr >= ROBOT_NR_ANIMATION_FRAMES) {
                        robotData[i].frameNr = 0;
                    }
                }
            }
            //remove robots off-screen
            var robotIndex = 0;
            while (robotIndex < robotData.length) {
                if (robotData[robotIndex].x < cameraX - ROBOT_WIDTH) {
                    robotData.splice(robotIndex, 1);
                    console.log('I removed a robot!');
                } else {
                    robotIndex += 1;
                }
            }

            if (robotData.length < MAX_ACTIVE_ROBOTS) {
                var lastRobotX = CANVAS_WIDTH;
                var lastRobotX = 0;
                if (robotData.length > 0) {
                    lastRobotX = robotData[robotData.length - 1].x;
                }
                var newRobotX = lastRobotX + MIN_DISTANCE_BETWEEN_ROBOTS + Math.random() * (MAX_DISTANCE_BETWEEN_ROBOTS - MIN_DISTANCE_BETWEEN_ROBOTS);
                robotData.push({
                    x: newRobotX,
                    y: GROUND_Y - ROBOT_HEIGHT,
                    frameNr: 0
                });
            }
        }

        function doesPlayerOverlapRobotAlongOneAxis(playerNearX, playerFarX, robotNearX, robotFarX) {
            var playerOverlapsNearRobotEdge = (playerFarX >= robotNearX) && (playerFarX <= robotFarX);
            var playerOverlapsFarRobotEdge = (playerNearX >= robotNearX) && (playerNearX <= robotFarX);
            var playerOverlapsEntireRobot = (playerNearX <= robotNearX) && (playerFarX >= robotFarX);
            return playerOverlapsNearRobotEdge || playerOverlapsFarRobotEdge || playerOverlapsEntireRobot;
        }
        function doesPlayerOverlapRobot(playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT, robotX, robotY, ROBOT_WIDTH, ROBOT_HEIGHT) {
            var playerOverlapsRobotOnXAxis = doesPlayerOverlapRobotAlongOneAxis(
                playerX,
                playerX + PLAYER_WIDTH,
                robotX + ROBOT_WIDTH,
            );
            var playerOverlapsRobotOnYAxis = doesPlayerOverlapRobotAlongOneAxis(
                playerY,
                playerY + PLAYER_HEIGHT,
                robotY,
                robotY + ROBOT_HEIGHT
            );
            return playerOverlapsRobotOnXAxis && playerOverlapsRobotOnYAxis;
        }

        //DRAWING
        function draw() {
            //Da sky
            c.fillStyle = 'LightSkyBlue';
            c.fillRect(0, 0, CANVAS_WIDTH, GROUND_Y - 40);

            //Da background
            var backgroundX = - (cameraX % BACKGROUND_WIDTH);
            c.drawImage(backgroundImage, backgroundX, -210);
            c.drawImage(backgroundImage, backgroundX + BACKGROUND_WIDTH, -210);

            //Da ground
            c.fillStyle = 'ForestGreen';
            c.fillRect(0, GROUND_Y - 40, CANVAS_WIDTH, CANVAS_HIEGHT - GROUND_Y + 40);

            //Da bush
            for (var i = 0; i < bushData.length; i++) {
                c.drawImage(bushData[i].image, bushData[i].x - cameraX, GROUND_Y - bushData[i].y - cameraY);
            }

            //Daftpunk
            for (var i = 0; i < robotData.length; i++) {
                drawAnimatedSprite(robotData[i].x - cameraX, robotData[i].y - cameraY, robotData[i].frameNr, robotSpriteSheet);
            }

            //drawing mr Nano
            drawAnimatedSprite(playerX - cameraX, playerY - cameraY, playerFrameNr, playerSpriteSheet);

            //spite animator
            function drawAnimatedSprite(screenX, screenY, frameNr, spriteSheet) {
                var spriteSheetRow = Math.floor(frameNr / spriteSheet.nrFramesPerRow);
                var spriteSheetColumn = frameNr % spriteSheet.nrFramesPerRow;
                var spriteSheetX = spriteSheetColumn * spriteSheet.spriteWidth;
                var spriteSheetY = spriteSheetRow * spriteSheet.spriteHeight;
                c.drawImage(
                    spriteSheet.image,
                    spriteSheetX, spriteSheetY,
                    spriteSheet.spriteWidth, spriteSheet.spriteHeight,
                    screenX, screenY,
                    spriteSheet.spriteWidth, spriteSheet.spriteHeight
                );
            }
        }

    </script>
</body>

</html>